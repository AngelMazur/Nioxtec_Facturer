version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    env_file:
      - .env
    environment:
      # Ensure production behavior in container
      FLASK_ENV: production
      PORT: 5000
      WKHTMLTOPDF_PATH: /usr/bin/wkhtmltopdf
      FORCE_HTTPS: "false"
    volumes:
      # Persist database and uploaded files
      - app_instance:/app/instance
      # Persist generated files (PDFs, downloads)
      - app_downloads:/app/downloads
    ports:
      # Exponer solo en loopback del host (Cloudflared accede a localhost)
      - "127.0.0.1:5000:5000"
    networks:
      - app_net

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    depends_on:
      - backend
    ports:
      # Exponer solo en loopback del host (Cloudflared accede a localhost)
      - "127.0.0.1:8080:8080"
    networks:
      - app_net

networks:
  app_net:
    driver: bridge

volumes:
  app_instance:
  app_downloads:
