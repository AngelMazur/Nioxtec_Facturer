# Checklist de Release (usar en cada despliegue)

- [ ] PR en `main` con CI verde (lint, tests, build frontend)
- [ ] Revisado CHANGELOG o notas de versión
- [ ] Tag creado: `vX.Y.Z`
- [ ] Variables de entorno correctas en runner (Windows):
  - [ ] DATABASE_URL
  - [ ] JWT_SECRET_KEY
  - [ ] ALLOW_QUERY_TOKEN=false (en producción)
  - [ ] WKHTMLTOPDF_PATH
  - [ ] APP_ENV=production
  - [ ] LIMITER_STORAGE_URI (ej. `redis://localhost:6379/0`, si aplica)
  - [ ] REDIS_URL (si aplica)
  - [ ] COMPANY_* (si no hay fila en BD): `COMPANY_NAME, COMPANY_CIF, COMPANY_ADDRESS, COMPANY_CITY, COMPANY_PROVINCE, COMPANY_EMAIL, COMPANY_PHONE, COMPANY_IBAN, COMPANY_WEBSITE`
- [ ] Infra del runner (Windows):
  - [x] Tareas programadas existen y están habilitadas: "Nioxtec Backend", "Nioxtec Frontend", "Cloudflared Tunnel". ✅
  - [x] Cloudflare Tunnel mapea `api.nioxtec.es` → `http://localhost:8000` (protocolo http y puerto 8000). ✅
  - [x] Archivo `.env` actualizado con `APP_VERSION` y `VENV_DIR` absoluto (escrito por el workflow durante el deploy). ✅
  - [x] `scripts/start_backend.ps1` carga `.env` y usa `VENV_DIR`; backend enlaza `PORT=8000`. ✅
  - [x] Salud local: `http://localhost:8000/health` responde 200 en el servidor. ✅
- [x] Backup de la base de datos completado ✅
- [x] `alembic upgrade head` sin errores ✅
- [x] Servicio reiniciado (NSSM/IIS/Waitress) ✅
- [x] `/health` = 200 y versión esperada ✅
- [ ] Smoke test manual:
  - [x] Login ✅
  - [ ] Crear cliente
  - [ ] Crear factura y generar PDF
  - [ ] Reporte mensual
- [x] Validar cookies JWT: `HttpOnly` + `Secure` + `SameSite=None` y que descargas no usen `?token=` ✅
- [ ] Rate limiting: provocar un 429 en `/api/auth/login` tras varios intentos rápidos
- [x] OpenAPI `/apidocs` carga y lista endpoints ✅
- [x] Validación: peticiones inválidas devuelven 400 con `{error, code}` ✅
- [x] `/openapi.json` responde 200 y contiene campo `openapi` ✅
- [x] Preflight CORS sobre endpoints clave (ej. `/api/auth/login`) devuelve cabeceras esperadas (`access-control-allow-origin`, métodos y headers) ✅
- [ ] `DEVELOPER/scripts/check_phase2_local.sh` pasa contra la URL local de backend
- [ ] `DEVELOPER/scripts/check_phase3_local.sh` pasa (auth, CORS, listados, política `?token`)
- [ ] Monitoreo/Sentry sin errores críticos
- [x] Documentar en `PHASES_HISTORY.md` ✅

Rollback
- [ ] `alembic downgrade -1`
- [ ] Reiniciar servicio
- [ ] Verificar `/health`
- [ ] Registrar incidencia y revertir tag si procede
