name: Deploy to Production (Windows Self‑Hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-production
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on:
      - self-hosted
      - windows
      - nioxtec
    timeout-minutes: 30
    steps:
      - name: Preflight – PowerShell policy
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

      - name: Despliegue vía tarea programada (fallback a script)
        shell: powershell
        run: |
          # Intentar ejecutar tarea si existe; si falla por permisos o inexistente, ejecutar script directo
          cmd.exe /c 'schtasks /Query /TN "Nioxtec Deploy CI" >NUL 2>&1'
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Tarea encontrada: ejecutando 'Nioxtec Deploy CI'"
            cmd.exe /c 'schtasks /Run /TN "Nioxtec Deploy CI"'
          } else {
            Write-Host "Tarea no disponible o acceso denegado: ejecutando script directo (inline)"
            $ErrorActionPreference = 'Continue'
            function Log([string]$m){ Write-Host ("[{0}] {1}" -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss'), $m) }
            try { Log 'Parando tareas backend/frontend'; schtasks /End /TN "Nioxtec Backend" 2>$null | Out-Null } catch {}
            try { schtasks /End /TN "Nioxtec Frontend" 2>$null | Out-Null } catch {}
            try {
              Log 'git pull y dependencias backend'
              Set-Location 'C:\Nioxtec\Nioxtec_Facturer'
              git pull
              if (Test-Path .\.venv310\Scripts\pip.exe) { .\.venv310\Scripts\pip.exe install -r requirements.txt }
            } catch { Log "Backend update error: $($_.Exception.Message)" }
            try {
              Log 'npm ci && build frontend'
              Set-Location 'C:\Nioxtec\Nioxtec_Facturer\frontend'
              npm ci
              $env:VITE_API_BASE = 'https://api.nioxtec.es'
              npm run build
            } catch { Log "Frontend build error: $($_.Exception.Message)" }
            try { Log 'Arrancando backend/frontend'; schtasks /Run /TN "Nioxtec Backend" 2>$null | Out-Null } catch {}
            try { schtasks /Run /TN "Nioxtec Frontend" 2>$null | Out-Null } catch {}
          }

      - name: Health‑check API
        shell: powershell
        run: |
          try {
            $code = (Invoke-WebRequest https://api.nioxtec.es/health -UseBasicParsing -TimeoutSec 10).StatusCode
            if ($code -ne 200) { Write-Error "API health returned $code"; exit 1 }
          } catch { Write-Error $_.Exception.Message; exit 1 }


