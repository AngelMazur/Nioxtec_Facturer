name: Deploy to Production (Windows Self‑Hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-production
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on:
      - self-hosted
      - windows
      - nioxtec
    timeout-minutes: 30
    steps:
      - name: Preflight – PowerShell policy
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force

      - name: Despliegue automático
        shell: powershell
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          $ErrorActionPreference = 'Continue'
          function Log([string]$m){ Write-Host ("[{0}] {1}" -f (Get-Date -Format 'yyyy-MM-dd HH:mm:ss'), $m) }
          
          try {
            Log 'Iniciando deploy automático'
            Set-Location 'C:\Nioxtec\Nioxtec_Facturer'
            git config --global --add safe.directory 'C:/Nioxtec/Nioxtec_Facturer'
            
            # Git pull con token
            $repoUrl = "https://x-access-token:$env:DEPLOY_TOKEN@github.com/AngelMazur/Nioxtec_Facturer.git"
            git remote set-url origin $repoUrl
            git fetch origin main --prune
            git reset --hard origin/main
            Log 'Código actualizado desde GitHub'
            
            # Instalar dependencias Python
            if (Test-Path '.\.venv310\Scripts\python.exe') {
              Log 'Instalando dependencias Python'
              & '.\.venv310\Scripts\python.exe' -m pip install -r requirements.txt --quiet
            } else {
              Log 'Python no encontrado - saltando instalación pip'
            }
            
            # Build frontend
            Log 'Compilando frontend'
            Set-Location 'C:\Nioxtec\Nioxtec_Facturer\frontend'
            npm ci --silent
            $env:VITE_API_BASE = 'https://api.nioxtec.es'
            npm run build
            Log 'Frontend compilado exitosamente'
            
            # Reiniciar servicios
            Log 'Reiniciando servicios'
            try { schtasks /End /TN "Nioxtec Backend" 2>$null | Out-Null } catch {}
            try { schtasks /End /TN "Nioxtec Frontend" 2>$null | Out-Null } catch {}
            Start-Sleep -Seconds 5
            try { schtasks /Run /TN "Nioxtec Backend" 2>$null | Out-Null } catch {}
            try { schtasks /Run /TN "Nioxtec Frontend" 2>$null | Out-Null } catch {}
            
            Log 'Deploy completado exitosamente'
            
          } catch {
            Log "Error en deploy: $($_.Exception.Message)"
            throw $_
          }

      - name: Verificar API
        shell: powershell
        run: |
          Start-Sleep -Seconds 15
          $maxRetries = 4
          
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest https://api.nioxtec.es/health -UseBasicParsing -TimeoutSec 20
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ API funcionando correctamente"
                exit 0
              }
            } catch {
              Write-Host "Intento $i/$maxRetries falló: $($_.Exception.Message)"
              if ($i -lt $maxRetries) { Start-Sleep -Seconds 10 }
            }
          }
          Write-Host "⚠️ API no responde, pero deploy se completó"


